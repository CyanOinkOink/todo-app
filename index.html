<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>品言计划</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
            position: relative;
            z-index: 1;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background-size: cover;
            background-position: center;
            z-index: -1;
            filter: blur(8px);
            transform: scale(1.01);
        }

        /* 菜单样式 */
        .menu-container {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 10;
        }
        
        .menu-btn {
            padding: 10px 16px;
            background-color: #7ec5ba;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            min-height: 40px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            letter-spacing: 0.5px;
        }
        
        .menu-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .menu-btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .menu-btn::after {
            content: "▼";
            font-size: 9px;
            margin-left: 4px;
            opacity: 0.9;
        }
        
        .menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
            min-width: 140px;
            margin-top: 6px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px);
            transition: all 0.2s ease;
            z-index: 100;
            overflow: hidden;
            border: 1px solid #f0f0f0;
        }
        
        .menu-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .menu-item {
            padding: 10px 14px;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 13px;
            color: #333;
            transition: background-color 0.15s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #f8f8f8;
            font-weight: 500;
        }
        
        .menu-item:last-child {
            border-bottom: none;
        }
        
        .menu-item:hover {
            background-color: #f8f8f8;
            color: #000;
        }
        
        .menu-item:active {
            background-color: #f0f0f0;
        }
        
        .menu-icon {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        /* 简约黑色图标 - 使用CSS绘制 */
        .icon-bg {
            position: relative;
            width: 14px;
            height: 14px;
            border: 1.5px solid #333;
            border-radius: 2px;
        }
        
        .icon-bg::before {
            content: "";
            position: absolute;
            width: 8px;
            height: 8px;
            border: 1.5px solid #333;
            border-radius: 1px;
            top: 2px;
            left: 2px;
        }
        
        .icon-archive {
            position: relative;
            width: 14px;
            height: 14px;
        }
        
        .icon-archive::before {
            content: "";
            position: absolute;
            width: 14px;
            height: 10px;
            border: 1.5px solid #333;
            border-top: none;
            border-radius: 0 0 2px 2px;
            top: 4px;
            left: 0;
        }
        
        .icon-archive::after {
            content: "";
            position: absolute;
            width: 8px;
            height: 1.5px;
            background: #333;
            top: 4px;
            left: 3px;
        }

        .container {
            width: 95%;
            max-width: 1200px;
            margin: 80px auto 20px;
            padding: 10px;
        }

        /* 响应式布局 - 大屏幕为左右布局 */
        @media (min-width: 768px) {
            .container {
                display: flex;
                justify-content: space-between;
                margin: 100px auto 20px;
                padding: 20px;
                width: 90%;
                height: calc(100vh - 140px);
                min-height: 600px;
            }
            
            .left-container, .right-container {
                width: 48%;
                margin-right: 2%;
                height: 100%;
                display: flex;
                flex-direction: column;
            }
            
            .right-container {
                margin-left: 2%;
                margin-right: 0;
            }
        }

        /* 响应式布局 - 小屏幕为上下布局 */
        @media (max-width: 767px) {
            .container {
                flex-direction: column;
            }
            
            .left-container, .right-container {
                width: 100%;
                margin: 0 0 20px 0;
            }
            
            h1 {
                font-size: 28px !important;
                padding: 8px 20px !important;
                margin-top: 60px !important;
            }
            
            .menu-container {
                top: 10px;
                right: 10px;
            }
            
            .menu-btn {
                padding: 8px 14px;
                font-size: 13px;
                min-height: 38px;
            }
            
            .menu-dropdown {
                min-width: 130px;
            }
            
            .menu-item {
                padding: 9px 12px;
                font-size: 12.5px;
            }
            
            .change-bg-btn, .add-btn, .set-daily-btn, .add-toggle-btn {
                padding: 12px 18px !important;
                font-size: 14px !important;
            }
            
            input[type="text"], input[type="time"], input[type="date"] {
                padding: 15px !important;
                font-size: 16px !important;
            }
            
            .button-container button {
                padding: 15px !important;
            }
            
            .todo-item, .daily-task {
                padding: 15px !important;
                margin: 8px 0 !important;
            }
            
            /* 小屏幕时删除按钮默认隐藏，悬停时显示 */
            .todo-item button, .daily-task button {
                display: none !important;
            }
            
            .todo-item:hover button, .daily-task:hover button {
                display: inline-block !important;
            }
        }

        .task-wrapper {
            width: 100%;
            overflow-y: auto;
            max-height: calc(100vh - 140px);
            padding: 0 5px;
        }

        /* 响应式标题 */
   h1 {
    text-align: center;
    font-size: 32px;
    margin-bottom: 10px;
    position: relative;
    z-index: 1;
    margin-top: 70px;
    display: inline-block;
    padding: 10px 25px;
    left: 50%;
    transform: translateX(-50%);
    white-space: nowrap;
    max-width: 90%;
    word-break: keep-all;
position: relative;
}
h1::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(255, 255, 255, 0.6);
backdrop-filter: blur(10px) saturate(180%);
    -webkit-backdrop-filter: blur(10px) saturate(180%);
border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 16px;
    box-shadow: 
        0 4px 20px rgba(0, 0, 0, 0.1),
        0 0 0 1px rgba(255, 255, 255, 0.1) inset,
        0 1px 1px rgba(255, 255, 255, 0.2) inset;
    z-index: -1;
    border-radius: 12px;
    width: 100%;

}
        /* 触摸友好的按钮 */
        .change-bg-btn, .add-btn, .set-daily-btn, .add-toggle-btn {
            padding: 12px 20px;
            background-color: #7ec5ba;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 15px;
            transition: 
                background-color 0.3s ease,
                box-shadow 0.3s ease,
                transform 0.1s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            --hover-shadow-light: 0 4px 12px rgba(0, 0, 0, 0.25);
            --hover-shadow-dark: 0 4px 12px rgba(255, 255, 255, 0.15);
            min-height: 44px;
        }

        .change-bg-btn:hover, .add-btn:hover, .set-daily-btn:hover, .add-toggle-btn:hover {
            box-shadow: var(--hover-shadow, var(--hover-shadow-light));
        }
        
        .change-bg-btn:active, .add-btn:active, .set-daily-btn:active, .add-toggle-btn:active {
            transform: translateY(2px);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .change-bg-btn, .add-btn, .set-daily-btn, .add-toggle-btn {
            color: white !important;
            font-weight: bold;
        }

        /* PC端固定高度的任务容器 */
        .left-container, .right-container {
            padding: 20px;
            background-color: #fff;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            position: relative;
            overflow: hidden; /* 隐藏溢出的滚动条 */
        }

        /* PC端固定高度，内部滚动 */
        @media (min-width: 768px) {
            .left-container > h2,
            .right-container > h2 {
                margin-top: 0;
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 1px solid #eee;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .add-todo, .add-daily-task {
                flex-shrink: 0;
                margin-bottom: 20px;
            }
            
            /* 滚动内容区域 - 固定在圆角内 */
            .task-list-container {
                flex: 1;
                overflow-y: auto;
                border-radius: 12px;
                margin: 0 -10px;
                padding: 0 10px;
                position: relative;
            }
            
            /* 优化滚动条样式 - 与圆角对齐 */
            .task-list-container::-webkit-scrollbar {
                width: 8px;
            }
            
            .task-list-container::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 10px;
                margin: 10px 0;
            }
            
            .task-list-container::-webkit-scrollbar-thumb {
                background: #c1c1c1;
                border-radius: 10px;
                border: 2px solid #fff;
                background-clip: padding-box;
            }
            
            .task-list-container::-webkit-scrollbar-thumb:hover {
                background: #a8a8a8;
            }
        }

        /* 小屏幕标题布局调整 */
        @media (max-width: 767px) {
            .left-container > h2,
            .right-container > h2 {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
            }
        }

        /* 移动端样式 */
        @media (max-width: 767px) {
            .task-list-container {
                overflow-y: visible;
            }
        }

        input[type="text"], input[type="time"], input[type="date"] {
            padding: 14px;
            margin-bottom: 12px;
            width: 100%;
            border-radius: 12px;
            border: 1px solid #ddd;
            font-size: 14px;
            -webkit-appearance: none;
        }

        .button-container {
            display: flex;
            gap: 10px;
            width: 100%;
            justify-content: space-between;
        }

        .button-container button {
            width: 100%;
            min-height: 44px;
        }

        .todo-item, .daily-task {
            background: #fff;
            padding: 14px;
            margin: 10px 0;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            position: relative;
            transition: background-color 0.3s ease;
            user-select: none;
            min-height: 54px; /* 统一最小高度 */
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .todo-item:hover, .daily-task:hover {
            background-color: #e0e0e0;
        }

        /* 删除按钮样式 - 默认隐藏，悬停时显示 */
        .todo-item button, .daily-task button {
            background-color: #ff4747;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 6px 12px;
            cursor: pointer;
            display: none; /* 默认隐藏 */
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%); /* 垂直居中 */
            min-height: 36px;
            min-width: 60px;
            z-index: 10; /* 确保在文本上方 */
        }

        /* 修复：已完成任务的删除按钮不会显示删除线 */
        .todo-item.completed button, 
        .daily-task.completed button {
            text-decoration: none !important;
        }

        .todo-item button:hover, .daily-task button:hover {
            background-color: #ff3333;
        }

        /* 悬停时显示删除按钮 */
        .todo-item:hover button, .daily-task:hover button {
            display: inline-block;
        }

        /* 确保已完成任务的文字有删除线，但删除按钮没有 */
        .todo-item.completed > div > span,
        .daily-task.completed > div > span {
            text-decoration: line-through;
            color: #888;
            opacity: 0.7;
        }

        .date-group h3 {
            font-size: 14px;
            color: #777;
            margin: 15px 0 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }

        .date-group {
            margin-bottom: 20px;
        }

        .todo-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .add-todo, .add-daily-task {
            margin-bottom: 25px;
        }

        .completed {
            text-decoration: line-through;
            color: #888;
            opacity: 0.7;
        }

        .input-row {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            width: 100%;
            flex-wrap: wrap;
        }

        .input-row input {
            flex: 1;
            min-width: 45%;
        }

        @media (max-width: 480px) {
            .input-row {
                flex-direction: column;
                gap: 8px;
            }
            
            .input-row input {
                width: 100%;
                min-width: 100%;
            }
        }

        @media (max-width: 767px) {
            input, select, textarea {
                font-size: 16px !important;
            }
        }
        
        .todo-item:active, .daily-task:active {
            background-color: #d0d0d0;
        }

        /* 自定义确认对话框样式 */
        .confirm-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .confirm-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .confirm-dialog {
            background-color: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transform: translateY(20px);
            transition: transform 0.3s ease;
            text-align: center;
        }

        .confirm-overlay.active .confirm-dialog {
            transform: translateY(0);
        }

        /* 简约的二维警告图标 */
        .confirm-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .confirm-icon::before {
            content: "";
            position: absolute;
            width: 60px;
            height: 60px;
            border: 4px solid #ff6b6b;
            border-radius: 50%;
            background-color: white;
        }

        .confirm-icon::after {
            content: "!";
            position: absolute;
            font-size: 32px;
            font-weight: bold;
            color: #ff6b6b;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .confirm-title {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .confirm-message {
            font-size: 16px;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.5;
            padding: 0 10px;
        }

        .confirm-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .confirm-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 100px;
            flex: 1;
        }

        .confirm-btn.cancel {
            background-color: #f0f0f0;
            color: #666;
        }

        .confirm-btn.cancel:hover {
            background-color: #e0e0e0;
        }

        /* 修改：确定按钮使用与添加按钮相同的颜色 */
        .confirm-btn.confirm {
            background-color: #7ec5ba;
            color: white;
            box-shadow: 0 2px 6px rgba(126, 197, 186, 0.3);
        }

        .confirm-btn.confirm:hover {
            background-color: #6fbf9d;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(126, 197, 186, 0.4);
        }

        .confirm-btn:active {
            transform: translateY(0);
        }

        /* 移动端适配 */
        @media (max-width: 480px) {
            .confirm-dialog {
                padding: 25px 20px;
                margin: 20px;
            }
            
            .confirm-icon {
                width: 60px;
                height: 60px;
                margin-bottom: 15px;
            }
            
            .confirm-icon::before {
                width: 50px;
                height: 50px;
                border-width: 3px;
            }
            
            .confirm-icon::after {
                font-size: 24px;
                height: 30px;
            }
            
            .confirm-title {
                font-size: 20px;
            }
            
            .confirm-message {
                font-size: 15px;
                margin-bottom: 25px;
            }
            
            .confirm-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .confirm-btn {
                padding: 15px;
                width: 100%;
            }
        }

        /* 动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(30px); }
            to { transform: translateY(0); }
        }

        .confirm-dialog {
            animation: slideUp 0.3s ease;
        }

        /* 任务时间样式 */
        .task-time {
            display: block;
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        /* 修复：统一任务文字颜色 */
        .todo-item > div > span,
        .daily-task {
            color: #333; /* 统一文字颜色 */
        }
        
        .todo-item.completed > div > span,
        .daily-task.completed {
            color: #888; /* 完成状态文字颜色 */
        }
        
        /* 归档面板样式 - 与主界面统一 */
        .archive-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .archive-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .archive-panel {
            background-color: white;
            border-radius: 20px;
            padding: 25px;
            width: 90%;
            max-width: 700px;
            max-height: 70vh;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transform: translateY(20px);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        .archive-overlay.active .archive-panel {
            transform: translateY(0);
        }
        
        .archive-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .archive-title {
            font-size: 22px;
            font-weight: bold;
            color: #333;
            margin: 0;
        }
        
        .close-archive-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 5px;
            line-height: 1;
        }
        
        .close-archive-btn:hover {
            color: #333;
        }
        
        .archive-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
            margin-bottom: 10px;
        }
        
        .archive-date-group {
            margin-bottom: 25px;
        }
        
        .archive-date-title {
            font-size: 14px;
            color: #777;
            margin: 15px 0 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .archive-task {
            background: #fff;
            padding: 14px;
            margin: 10px 0;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: relative;
            user-select: none;
            min-height: 54px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border-left: 4px solid #7ec5ba;
        }
        
        .archive-task-content {
            color: #333;
            font-size: 14.5px;
            line-height: 1.4;
        }
        
        .archive-task-time {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
            display: block;
        }
        
        /* 与主界面统一：无时间的任务不显示时间行 */
        .archive-task.no-time .archive-task-content {
            color: #333;
        }
        
        /* 归档中已完成的任务样式 */
        .archive-task.completed .archive-task-content {
            text-decoration: line-through;
            color: #888;
            opacity: 0.7;
        }
        
        .archive-actions {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
        }
        
        .clear-archive-btn {
            padding: 10px 20px;
            background-color: #ff6b6b;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .clear-archive-btn:hover {
            background-color: #ff5252;
        }
        
        /* 移动端适配 */
        @media (max-width: 767px) {
            .archive-panel {
                padding: 20px;
                margin: 15px;
                max-height: 75vh;
            }
            
            .archive-title {
                font-size: 20px;
            }
            
            .archive-task {
                padding: 15px;
                margin: 8px 0;
            }
        }
        
        /* 滚动条样式 */
        .archive-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .archive-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .archive-content::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
            border: 2px solid #fff;
            background-clip: padding-box;
        }
        
        .archive-content::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* ========== 新增：浮窗样式 ========== */
        .form-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .form-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .form-panel {
            background-color: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transform: translateY(20px);
            transition: transform 0.3s ease;
            position: relative;
        }
        
        .form-overlay.active .form-panel {
            transform: translateY(0);
        }
        
        .close-form-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 5px;
            line-height: 1;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        
        .close-form-btn:hover {
            background-color: #f5f5f5;
            color: #333;
        }
        
        .form-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            padding-right: 30px;
            color: #333;
        }
        
        /* 隐藏原来的输入区域 */
        .add-todo, .add-daily-task {
            display: none !important;
        }

        /* 添加按钮样式调整 */
        .add-toggle-btn {
            padding: 8px 16px !important;
            min-width: 44px;
            min-height: 44px;
            font-size: 18px !important;
            margin-left: 10px;
        }

        /* 标题区域样式 */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        /* 用户名设置样式 */
        .name-setup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .name-setup-overlay.hidden {
            opacity: 0;
            visibility: hidden;
        }
        
        .name-setup-panel {
            background-color: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            position: relative;
        }
        
        .name-setup-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        
        .name-setup-subtitle {
            font-size: 16px;
            color: #666;
            margin-bottom: 25px;
        }
        
        .name-input {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .name-input:focus {
            outline: none;
            border-color: #7ec5ba;
        }
        
        .name-submit-btn {
            padding: 12px 40px;
            background-color: #7ec5ba;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .name-submit-btn:hover {
            background-color: #6fbf9d;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(126, 197, 186, 0.4);
        }
        
        .name-error {
            color: #ff6b6b;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>

<div id="nameSetupOverlay" class="name-setup-overlay">
    <div class="name-setup-panel">
        <h2 class="name-setup-title">欢迎使用品言计划</h2>
        <p class="name-setup-subtitle">请输入您的用户名（2个汉字）</p>
        <input type="text" id="userNameInput" class="name-input" maxlength="2" placeholder="请输入2个汉字">
        <p id="nameError" class="name-error">请输入2个汉字作为用户名</p>
        <button class="name-submit-btn" onclick="setUserName()">开始使用</button>
    </div>
</div>

<h1 id="greeting"></h1>
<div id="dateDisplay" class="date-display"></div>

<!-- 菜单容器 -->
<div class="menu-container">
    <button class="menu-btn" onclick="toggleMenu()">菜单</button>
    <div class="menu-dropdown" id="menuDropdown">
        <button class="menu-item" onclick="changeBackground()">
            <span class="menu-icon">
                <div class="icon-bg"></div>
            </span>
            更换背景
        </button>
        <button class="menu-item" onclick="showArchive()">
            <span class="menu-icon">
                <div class="icon-archive"></div>
            </span>
            查看归档
        </button>
    </div>
</div>

<!-- 归档面板 -->
<div class="archive-overlay" id="archiveOverlay">
    <div class="archive-panel">
        <div class="archive-header">
            <h2 class="archive-title">已归档的任务</h2>
            <button class="close-archive-btn" onclick="hideArchive()">×</button>
        </div>
        
        <div class="archive-content" id="archiveContent">
            <!-- 归档内容将通过JavaScript动态生成 -->
        </div>
        
        <div class="archive-actions">
            <button class="clear-archive-btn" onclick="clearArchive()">清空归档</button>
        </div>
    </div>
</div>

<!-- 自定义确认对话框 -->
<div class="confirm-overlay" id="confirmDialog">
    <div class="confirm-dialog">
        <div class="confirm-icon"></div>
        <div class="confirm-title" id="confirmTitle">确认操作</div>
        <div class="confirm-message" id="confirmMessage">确定要执行此操作吗？</div>
        <div class="confirm-buttons">
            <button class="confirm-btn cancel" onclick="hideConfirm()">取消</button>
            <button class="confirm-btn confirm" onclick="confirmAction()">确定</button>
        </div>
    </div>
</div>

<!-- 日常任务浮窗 -->
<div class="form-overlay" id="dailyTaskFormOverlay">
    <div class="form-panel">
        <button class="close-form-btn" onclick="toggleDailyTaskForm()">×</button>
        <h3 class="form-title">添加日常任务</h3>
        <div class="add-daily-task-form">
            <input type="text" id="dailyTaskInputForm" placeholder="输入日常任务" />
            <div class="input-row">
                <input type="time" id="dailyTaskStartTimeForm" />
                <input type="time" id="dailyTaskEndTimeForm" />
            </div>
            <div class="button-container">
                <button class="set-daily-btn" onclick="addDailyTaskFromForm()">添加</button>
            </div>
        </div>
    </div>
</div>

<!-- 普通任务浮窗 -->
<div class="form-overlay" id="todoFormOverlay">
    <div class="form-panel">
        <button class="close-form-btn" onclick="toggleTodoForm()">×</button>
        <h3 class="form-title">添加普通任务</h3>
        <div class="add-todo-form">
            <div class="input-row">
                <input type="date" id="todoDateForm" value="" />
                <input type="text" id="todoInputForm" placeholder="添加待办事项" />
            </div>
            <div class="input-row">
                <input type="time" id="todoStartTimeForm" />
                <input type="time" id="todoEndTimeForm" />
            </div>
            <div class="button-container">
                <button class="add-btn" onclick="addTodoFromForm()">添加</button>
            </div>
        </div>
    </div>
</div>

<div class="background" id="background"></div>

<input type="file" id="fileInput" style="display: none;" accept="image/*" onchange="setBackgroundImage(event)">

<div class="task-wrapper">
    <div class="container">
        <div class="left-container">
            <h2>普通任务 <button class="add-toggle-btn" onclick="toggleTodoForm()">+</button></h2>
            
            <!-- 固定高度的滚动容器 -->
            <div class="task-list-container">
                <div id="todoList"></div>
            </div>
        </div>

        <div class="right-container">
            <h2>日常任务 <button class="add-toggle-btn" onclick="toggleDailyTaskForm()">+</button></h2>
            
            <!-- 固定高度的滚动容器 -->
            <div class="task-list-container">
                <div id="dailyTaskList"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // 全局变量
    let userName = localStorage.getItem('userName') || '';
    let todoData = JSON.parse(localStorage.getItem('todoData')) || [];
    let dailyTaskData = JSON.parse(localStorage.getItem('dailyTaskData')) || [];
    let archivedTodos = JSON.parse(localStorage.getItem('archivedTodos')) || [];
    
    // 0点重置相关的变量
    let lastResetDate = localStorage.getItem('lastResetDate') || null;
    let currentDate = new Date().toDateString();
    
    // 菜单状态
    let isMenuOpen = false;

    // 用户名设置
    function checkUserName() {
        if (!userName) {
            document.getElementById('nameSetupOverlay').classList.remove('hidden');
        } else {
            document.getElementById('nameSetupOverlay').classList.add('hidden');
            updateGreeting();
      
        }
    }

    function setUserName() {
        const nameInput = document.getElementById('userNameInput').value;
        const nameError = document.getElementById('nameError');
        
        // 检查是否为2个汉字
        const chineseRegex = /^[\u4e00-\u9fa5]{2}$/;
        
        if (!chineseRegex.test(nameInput)) {
            nameError.style.display = 'block';
            return;
        }
        
        nameError.style.display = 'none';
        userName = nameInput;
        localStorage.setItem('userName', userName);
        document.getElementById('nameSetupOverlay').classList.add('hidden');
        updateGreeting();
          }
// ========== 农历计算系统（2020-2030） ==========
class LunarCalendar {
    constructor() {
        // 农历数据表（2020-2030年）
        this.lunarInfo = [
            0x04bd8, // 2020
            0x04ae0, // 2021
            0x0a570, // 2022
            0x054d5, // 2023
            0x0d260, // 2024
            0x0d950, // 2025
            0x16554, // 2026
            0x056a0, // 2027
            0x09ad0, // 2028
            0x055d2, // 2029
            0x04ae0  // 2030
        ];
        
        // 生肖
        this.zodiacs = ['鼠','牛','虎','兔','龙','蛇','马','羊','猴','鸡','狗','猪'];
        
        // 天干
        this.heavenlyStems = ['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
        
        // 地支
        this.earthlyBranches = ['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];
        
        // 农历月份
        this.monthNames = ['正月','二月','三月','四月','五月','六月','七月','八月','九月','十月','冬月','腊月'];
        
        // 农历日期
        this.dayNames = ['初一','初二','初三','初四','初五','初六','初七','初八','初九','初十',
                        '十一','十二','十三','十四','十五','十六','十七','十八','十九','二十',
                        '廿一','廿二','廿三','廿四','廿五','廿六','廿七','廿八','廿九','三十'];
        
        // 农历节日（月-日）
        this.lunarFestivals = {
            '1-1': '春节',
            '1-15': '元宵节',
            '5-5': '端午节',
            '8-15': '中秋节',
            '9-9': '重阳节',
            '12-8': '腊八节',
            '12-23': '小年'
        };
    }
    
    // 计算农历年
    getLunarYear(year) {
        return year - 2020 + 1; // 从2020年开始索引
    }
    
    // 计算生肖
    getZodiac(year) {
        return this.zodiacs[(year - 2020) % 12];
    }
    
    // 计算农历日期
    getLunarDate(solarDate = new Date()) {
        const year = solarDate.getFullYear();
        const month = solarDate.getMonth() + 1;
        const day = solarDate.getDate();
        
        // 如果年份不在2020-2030范围内，返回默认值
        if (year < 2020 || year > 2030) {
            return {
                year: year,
                month: '正月',
                day: '初一',
                isLeap: false,
                zodiac: this.getZodiac(year),
                toString: function() {
                    return `${this.year}年${this.month}${this.day}`;
                }
            };
        }
        
        // 计算农历
        const lunarYear = year;
        const lunarMonth = this.calcLunarMonth(year, month, day);
        const lunarDay = this.calcLunarDay(year, month, day);
        
        return {
            year: lunarYear,
            month: this.monthNames[lunarMonth - 1] || '正月',
            day: this.dayNames[lunarDay - 1] || '初一',
            isLeap: false,
            zodiac: this.getZodiac(year),
            toString: function() {
                return `${this.year}年${this.month}${this.day}`;
            }
        };
    }
    
    // 简化计算农历月份
    calcLunarMonth(year, month, day) {
        // 这里使用简化算法，实际农历算法很复杂
        // 返回近似的农历月份
        const baseMonth = month;
        return Math.min(Math.max(baseMonth, 1), 12);
    }
    
    // 简化计算农历日期
    calcLunarDay(year, month, day) {
        // 返回近似的农历日期
        return Math.min(Math.max(day, 1), 30);
    }
    
    // 获取农历节日
    getLunarFestival(lunarMonth, lunarDay) {
        const key = `${lunarMonth}-${lunarDay}`;
        return this.lunarFestivals[key] || null;
    }
}

// 创建农历实例
const lunarCalendar = new LunarCalendar();
 // ========== 节日问候判断（支持公历和农历） ==========
function getFestivalGreeting() {
    const now = new Date();
    const month = now.getMonth() + 1;
    const day = now.getDate();
    const year = now.getFullYear();
    
    // 1. 检查生日（优先级最高）
    if ((month === 4 && day === 3) || (month === 2 && day === 19)) {
        return "生日快乐";
    }
    
    // 2. 公历节日数据库
    const solarFestivals = {
        '1-1': '元旦快乐',
        '2-14': '情人节快乐',
        '3-8': '妇女节快乐',
        '4-1': '愚人节快乐',
        '5-1': '劳动节快乐',
        '6-1': '儿童节快乐',
        '9-10': '教师节快乐',
        '10-1': '国庆节快乐',
        '12-24': '平安夜快乐',
        '12-25': '圣诞节快乐'
    };
    
    const solarKey = `${month}-${day}`;
    if (solarFestivals[solarKey]) {
        return solarFestivals[solarKey];
    }
    
    // 3. 检查农历节日（仅在2020-2030年范围内）
    if (year >= 2020 && year <= 2030) {
        const lunarDate = lunarCalendar.getLunarDate(now);
        
        // 获取农历月份和日期的数字
        const lunarMonthNum = this.getLunarMonthNumber(lunarDate.month);
        const lunarDayNum = this.getLunarDayNumber(lunarDate.day);
        
        if (lunarMonthNum && lunarDayNum) {
            const lunarFestival = lunarCalendar.getLunarFestival(lunarMonthNum, lunarDayNum);
            if (lunarFestival) {
                return `${lunarFestival}快乐`;
            }
        }
    }
    
    return null;
}

// 辅助函数：农历月份转数字
function getLunarMonthNumber(lunarMonthStr) {
    const monthMap = {
        '正月': 1, '二月': 2, '三月': 3, '四月': 4, '五月': 5, '六月': 6,
        '七月': 7, '八月': 8, '九月': 9, '十月': 10, '冬月': 11, '腊月': 12
    };
    return monthMap[lunarMonthStr] || null;
}

// 辅助函数：农历日期转数字
function getLunarDayNumber(lunarDayStr) {
    const dayMap = {};
    for (let i = 1; i <= 30; i++) {
        dayMap[lunarCalendar.dayNames[i-1]] = i;
    }
    return dayMap[lunarDayStr] || null;
}
    // 根据时间获取问候语（修改版，加入节日判断）
    function getGreeting() {
        const festivalGreeting = getFestivalGreeting();
        if (festivalGreeting) {
            return `${festivalGreeting}，${userName}！`;
        }
        
        const now = new Date();
        const hour = now.getHours();
        
        if (hour >= 23 || hour < 4) {
            return `晚安，${userName}！`;
        } else if (hour < 6) {
            return `凌晨好，${userName}！`;
        } else if (hour < 9) {
            return `早上好，${userName}！`;
        } else if (hour < 12) {
            return `上午好，${userName}！`;
        } else if (hour < 14) {
            return `中午好，${userName}！`;
        } else if (hour < 18) {
            return `下午好，${userName}！`;
        } else {
            return `晚上好，${userName}！`;
        }
    }

    function updateGreeting() {
        const greetingElement = document.getElementById('greeting');
        if (greetingElement) {
            greetingElement.textContent = getGreeting();
        }
    }
      // 格式化日期显示（用于普通任务板块）
function formatDateForDisplay(dateStr) {
    const now = new Date();
    const currentYear = now.getFullYear();
    const today = now.toISOString().split('T')[0];
    const tomorrow = new Date(now.getTime() + 86400000).toISOString().split('T')[0];
    
    const date = new Date(dateStr);
    const year = date.getFullYear();
    const month = date.getMonth() + 1;
    const day = date.getDate();
    
    const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
    const weekday = weekdays[date.getDay()];
    
    // 检查是否为今天
    if (dateStr === today) {
        return `今天 ${weekday}`;
    }
    
    // 检查是否为明天
    if (dateStr === tomorrow) {
        return `明天 ${weekday}`;
    }
    
    // 如果是今年，不显示年份
    if (year === currentYear) {
        return `${month}月${day}日 ${weekday}`;
    } else {
        return `${year}年${month}月${day}日 ${weekday}`;
    }
}

    // 数据初始化函数
    function initializeData() {
        // 检查是否需要0点重置日常任务和归档任务
        checkAndResetDailyTasks();
        checkAndArchiveOldTasks(); // 新增：检查是否需要归档旧任务
        
        // 添加完成状态到现有数据（兼容旧数据）
        dailyTaskData = dailyTaskData.map(task => {
            if (task.completed === undefined) {
                task.completed = false;
            }
            // 确保每个日常任务都有唯一的ID
            if (!task.id) {
                task.id = new Date().getTime() + Math.random();
            }
            return task;
        });
        
        // 对日常任务进行排序
        sortDailyTaskData();
        
        // 保存更新后的数据
        localStorage.setItem('dailyTaskData', JSON.stringify(dailyTaskData));
        
        // 对普通任务进行排序
        sortTodoData();
    }

    // 检查并重置日常任务完成状态
    function checkAndResetDailyTasks() {
        // 如果是新的一天（当前日期与上次重置日期不同）
        if (lastResetDate !== currentDate) {
            // 检查当前时间是否在0点之后（凌晨）
            const now = new Date();
            const currentHour = now.getHours();
            
            // 只有在0点-6点之间访问页面时才自动重置
            if (currentHour >= 0 && currentHour < 6) {
                // 重置所有日常任务的完成状态
                dailyTaskData.forEach(task => {
                    task.completed = false;
                });
                
                // 更新最后重置日期
                lastResetDate = currentDate;
                localStorage.setItem('lastResetDate', currentDate);
                localStorage.setItem('dailyTaskData', JSON.stringify(dailyTaskData));
                
                console.log('日常任务已在0点自动重置');
            }
        }
    }

    // 新增：检查并归档昨天的已完成任务
    function checkAndArchiveOldTasks() {
        const now = new Date();
        const today = now.toISOString().split('T')[0];
        const yesterday = new Date(now.getTime() - 86400000).toISOString().split('T')[0];
        
        // 检查是否有昨天完成的任务需要归档
        let hasChanges = false;
        
        // 找出昨天完成但未归档的任务
        const yesterdayCompletedTodos = todoData.filter(todo => {
            return todo.date === yesterday && todo.completed && !todo.archived;
        });
        
        if (yesterdayCompletedTodos.length > 0) {
            console.log(`发现 ${yesterdayCompletedTodos.length} 个昨天完成的任务需要归档`);
            
            // 归档这些任务
            yesterdayCompletedTodos.forEach(todo => {
                archiveTodo(todo, true); // true表示这是昨天的任务
            });
            
            hasChanges = true;
        }
        
        // 找出前天或更早的已完成任务（包括今天的旧任务）
        const oldCompletedTodos = todoData.filter(todo => {
            if (!todo.completed) return false;
            
            // 如果是今天的任务，不归档
            if (todo.date === today) return false;
            
            // 标记为已归档，避免重复处理
            return !todo.archived;
        });
        
        if (oldCompletedTodos.length > 0) {
            console.log(`发现 ${oldCompletedTodos.length} 个旧任务需要归档`);
            
            oldCompletedTodos.forEach(todo => {
                archiveTodo(todo, true);
            });
            
            hasChanges = true;
        }
        
        if (hasChanges) {
            // 保存更新后的数据
            localStorage.setItem('todoData', JSON.stringify(todoData));
            localStorage.setItem('archivedTodos', JSON.stringify(archivedTodos));
            
            // 重新渲染任务列表
            renderTodos();
        }
    }

    // 设置默认日期为今天
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById("todoDateForm").value = new Date().toISOString().split('T')[0];
        // 检查用户名
        checkUserName();
        
        // 监听用户名输入框的Enter键
        document.getElementById('userNameInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                setUserName();
            }
        });
    });

    // 自定义确认对话框函数
    function showConfirm(title, message, callback) {
        document.getElementById('confirmTitle').textContent = title;
        document.getElementById('confirmMessage').textContent = message;
        confirmCallback = callback;
        
        const dialog = document.getElementById('confirmDialog');
        dialog.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function hideConfirm() {
        const dialog = document.getElementById('confirmDialog');
        dialog.classList.remove('active');
        document.body.style.overflow = '';
        confirmCallback = null;
        deleteDailyTaskData = null;
        deleteDailyTaskDiv = null;
        deleteTodoId = null;
    }

    function confirmAction() {
        if (confirmCallback) {
            confirmCallback();
        }
        hideConfirm();
    }

    function getColorBrightness(rgbStr) {
        if (!rgbStr || rgbStr === 'transparent' || rgbStr === 'rgba(0, 0, 0, 0)') {
            return 255;
        }
        
        const rgbMatch = rgbStr.match(/\d+/g);
        if (!rgbMatch) return 255;
        
        const rgb = rgbMatch.map(Number);
        return (rgb[0] * 299 + rgb[1] * 587 + rgb[2] * 114) / 1000;
    }

    function calculateHoverColor(rgbStr) {
        if (!rgbStr || rgbStr === 'transparent' || rgbStr === 'rgba(0, 0, 0, 0)') {
            return '#6fbf9d';
        }
        
        const rgbMatch = rgbStr.match(/\d+/g);
        if (!rgbMatch || rgbMatch.length < 3) return '#6fbf9d';
        
        const rgb = rgbMatch.map(Number);
        const brightness = (rgb[0] * 299 + rgb[1] * 587 + rgb[2] * 114) / 1000;
        
        if (brightness > 180) {
            return `rgb(${Math.max(0, rgb[0] - 30)}, ${Math.max(0, rgb[1] - 30)}, ${Math.max(0, rgb[2] - 30)})`;
        } else if (brightness > 128) {
            return `rgb(${Math.max(0, rgb[0] - 20)}, ${Math.max(0, rgb[1] - 20)}, ${Math.max(0, rgb[2] - 20)})`;
        } else if (brightness > 60) {
            return `rgb(${Math.max(0, rgb[0] - 15)}, ${Math.max(0, rgb[1] - 15)}, ${Math.max(0, rgb[2] - 15)})`;
        } else {
            return `rgb(${Math.min(255, rgb[0] + 20)}, ${Math.min(255, rgb[1] + 20)}, ${Math.min(255, rgb[2] + 20)})`;
        }
    }

    function updateButtonStyles(buttons, baseColor) {
        buttons.forEach(button => {
            if (!baseColor || baseColor === 'rgb(0, 0, 0)') {
                baseColor = '#7ec5ba';
            }
            
            button.style.backgroundColor = baseColor;
            
            const brightness = getColorBrightness(baseColor);
            
            if (brightness > 128) {
                button.style.setProperty('--hover-shadow', 'var(--hover-shadow-light)');
            } else {
                button.style.setProperty('--hover-shadow', 'var(--hover-shadow-dark)');
            }
            
            const hoverColor = calculateHoverColor(baseColor);
            button.style.setProperty('--hover-color', hoverColor);
            
            // 同时更新确认对话框的确定按钮
            const confirmBtn = document.querySelector('.confirm-btn.confirm');
            if (confirmBtn) {
                confirmBtn.style.backgroundColor = baseColor;
                confirmBtn.style.setProperty('--hover-color', hoverColor);
            }
            
            button.onmouseenter = function() {
                this.style.backgroundColor = hoverColor;
            };
            
            button.onmouseleave = function() {
                this.style.backgroundColor = baseColor;
            };
        });
    }

    function adjustButtonColor(imageSrc) {
        const img = new Image();
        img.src = imageSrc;

        img.onload = function() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 1;
            canvas.height = 1;
            ctx.drawImage(img, 0, 0, 1, 1);

            const pixel = ctx.getImageData(0, 0, 1, 1).data;
            const baseColor = `rgb(${pixel[0]}, ${pixel[1]}, ${pixel[2]})`;

            const buttons = document.querySelectorAll('.menu-btn, .add-btn, .set-daily-btn, .add-toggle-btn, .confirm-btn.confirm');
            updateButtonStyles(buttons, baseColor);
        };
        
        img.onerror = function() {
            const buttons = document.querySelectorAll('.menu-btn, .add-btn, .set-daily-btn, .add-toggle-btn, .confirm-btn.confirm');
            const defaultColor = '#7ec5ba';
            updateButtonStyles(buttons, defaultColor);
        };
    }

    function loadBackground() {
        const savedBackground = localStorage.getItem('backgroundImage');
        if (savedBackground) {
            const background = document.getElementById('background');
            background.style.backgroundImage = `url(${savedBackground})`;
            adjustButtonColor(savedBackground);
        }
    }

    function saveBackground(imageSrc) {
        localStorage.setItem('backgroundImage', imageSrc);
    }

    // 日常任务排序函数
    function sortDailyTaskData() {
        dailyTaskData.sort((a, b) => {
            // 首先，未完成的排在前面
            if (!a.completed && b.completed) return -1;
            if (a.completed && !b.completed) return 1;
            
            // 都有时间时，按起始时间排序
            const aHasTime = a.startTime && a.endTime;
            const bHasTime = b.startTime && b.endTime;
            
            if (aHasTime && !bHasTime) return -1;
            if (!aHasTime && bHasTime) return 1;
            
            // 都有时间时按起始时间排序
            if (aHasTime && bHasTime) {
                return a.startTime.localeCompare(b.startTime);
            }
            
            // 都没有时间时按添加顺序（ID）排序
            return a.id - b.id;
        });
    }

    // 普通任务排序函数
    function sortTodoData() {
        todoData.sort((a, b) => {
            // 首先按日期排序
            const dateCompare = a.date.localeCompare(b.date);
            if (dateCompare !== 0) return dateCompare;
            
            // 同一天内，未完成的排在前面
            if (!a.completed && b.completed) return -1;
            if (a.completed && !b.completed) return 1;
            
            // 同一天内，有时间的排在前面
            const aHasTime = a.startTime && a.endTime;
            const bHasTime = b.startTime && b.endTime;
            
            if (aHasTime && !bHasTime) return -1;
            if (!aHasTime && bHasTime) return 1;
            
            // 都有时间时按起始时间排序
            if (aHasTime && bHasTime) {
                return a.startTime.localeCompare(b.startTime);
            }
            
            // 都没有时间时按添加顺序（ID）排序
            return a.id - b.id;
        });
    }

    // 添加示例任务（仅第一次运行时添加）
    function addSampleTasks() {
        if (todoData.length === 0 && dailyTaskData.length === 0 && archivedTodos.length === 0) {
            // 添加几个普通任务示例
            const today = new Date().toISOString().split('T')[0];
            const tomorrow = new Date(Date.now() + 86400000).toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
            
            // 今天的有时间任务
            todoData.push({
                task: '完成项目报告',
                date: today,
                startTime: '09:00',
                endTime: '11:00',
                id: Date.now() + 1,
                completed: false,
                archived: false
            });
            
            // 今天的无时间任务
            todoData.push({
                task: '阅读技术文档',
                date: today,
                startTime: '',
                endTime: '',
                id: Date.now() + 2,
                completed: false,
                archived: false
            });
            
            // 明天的任务
            todoData.push({
                task: '团队会议',
                date: tomorrow,
                startTime: '14:00',
                endTime: '16:00',
                id: Date.now() + 3,
                completed: false,
                archived: false
            });
            
            // 昨天的已完成任务（示例）
            todoData.push({
                task: '昨天完成的任务示例',
                date: yesterday,
                startTime: '10:00',
                endTime: '12:00',
                id: Date.now() + 8,
                completed: true,
                archived: false
            });
            
            // 添加日常任务示例
            dailyTaskData.push({
                task: '晨间锻炼',
                startTime: '07:00',
                endTime: '08:00',
                completed: false,
                id: Date.now() + 4
            });
            
            dailyTaskData.push({
                task: '学习新知识',
                startTime: '',
                endTime: '',
                completed: false,
                id: Date.now() + 5
            });
            
            // 添加归档任务示例（模拟之前完成的任务）
            archivedTodos.push({
                task: '整理工作台',
                date: yesterday,
                startTime: '10:00',
                endTime: '11:30',
                id: Date.now() + 6,
                completed: true,
                archivedDate: yesterday,
                archivedTime: '11:45'
            });
            
            archivedTodos.push({
                task: '购买办公用品',
                date: yesterday,
                startTime: '',
                endTime: '',
                id: Date.now() + 7,
                completed: true,
                archivedDate: yesterday,
                archivedTime: '16:20'
            });
            
            // 保存到本地存储
            localStorage.setItem('todoData', JSON.stringify(todoData));
            localStorage.setItem('dailyTaskData', JSON.stringify(dailyTaskData));
            localStorage.setItem('archivedTodos', JSON.stringify(archivedTodos));
            
            console.log('示例任务已添加');
        }
    }

    window.onload = function() {
        checkUserName();
        loadBackground();
        initializeData(); // 初始化数据，包括排序和0点重置检查
        
        // 添加示例任务（仅第一次运行）
        addSampleTasks();
        
        // 显示日常任务
        renderDailyTasks();
        renderTodos();
        
        const buttons = document.querySelectorAll('.menu-btn, .add-btn, .set-daily-btn, .add-toggle-btn, .confirm-btn.confirm');
        const defaultColor = '#7ec5ba';
        updateButtonStyles(buttons, defaultColor);
        
        // 设置浮窗的点击外部关闭事件
        setupFormOverlayEvents();
        
        // 每小时检查一次时间，用于更新问候语
        setInterval(updateGreeting, 60 * 60 * 1000);
        
        // 每分钟检查一次是否到了0点需要重置日常任务和归档任务
        setInterval(checkMidnightReset, 60 * 1000);
        
        
    };

    // 检查是否到达0点需要重置日常任务和归档任务
    function checkMidnightReset() {
        const now = new Date();
        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();
        
        // 在0点整执行（允许前后几分钟的误差）
        if (currentHour === 0 && currentMinute < 5) {
            const today = now.toDateString();
            if (lastResetDate !== today) {
                // 1. 重置所有日常任务的完成状态
                dailyTaskData.forEach(task => {
                    task.completed = false;
                });
                
                // 2. 归档昨天的已完成任务
                checkAndArchiveOldTasks();
                
                // 更新最后重置日期
                lastResetDate = today;
                localStorage.setItem('lastResetDate', today);
                localStorage.setItem('dailyTaskData', JSON.stringify(dailyTaskData));
                
                // 重新渲染日常任务
                renderDailyTasks();
                
                console.log('日常任务已在0点自动重置，并检查了任务归档');
            }
        }
        
        // 更新当前日期
        currentDate = now.toDateString();
    }

    // 菜单功能
    function toggleMenu() {
        const menu = document.getElementById('menuDropdown');
        menu.classList.toggle('active');
        isMenuOpen = !isMenuOpen;
    }
    
    function closeMenu() {
        const menu = document.getElementById('menuDropdown');
        menu.classList.remove('active');
        isMenuOpen = false;
    }
    
    // 点击页面其他位置关闭菜单
    document.addEventListener('click', function(e) {
        const menu = document.getElementById('menuDropdown');
        const menuBtn = document.querySelector('.menu-btn');
        
        if (isMenuOpen && !menu.contains(e.target) && !menuBtn.contains(e.target)) {
            closeMenu();
        }
    });
    
    // 按ESC键关闭菜单
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && isMenuOpen) {
            closeMenu();
        }
    });

    // ========== 新增：浮窗功能 ==========
    function toggleDailyTaskForm() {
        const overlay = document.getElementById('dailyTaskFormOverlay');
        overlay.classList.toggle('active');
        document.body.style.overflow = overlay.classList.contains('active') ? 'hidden' : '';
        
        // 如果打开浮窗，聚焦到第一个输入框
        if (overlay.classList.contains('active')) {
            setTimeout(() => {
                document.getElementById('dailyTaskInputForm').focus();
            }, 100);
        }
    }
    
    function toggleTodoForm() {
        const overlay = document.getElementById('todoFormOverlay');
        overlay.classList.toggle('active');
        document.body.style.overflow = overlay.classList.contains('active') ? 'hidden' : '';
        
        // 如果打开浮窗，设置默认日期并聚焦
        if (overlay.classList.contains('active')) {
            document.getElementById('todoDateForm').value = new Date().toISOString().split('T')[0];
            setTimeout(() => {
                document.getElementById('todoInputForm').focus();
            }, 100);
        }
    }
    
    // 设置浮窗点击外部关闭事件
    function setupFormOverlayEvents() {
        // 日常任务浮窗
        document.getElementById('dailyTaskFormOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                toggleDailyTaskForm();
            }
        });
        
        // 普通任务浮窗
        document.getElementById('todoFormOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                toggleTodoForm();
            }
        });
        
        // 按ESC键关闭浮窗
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const dailyOverlay = document.getElementById('dailyTaskFormOverlay');
                const todoOverlay = document.getElementById('todoFormOverlay');
                
                if (dailyOverlay.classList.contains('active')) {
                    toggleDailyTaskForm();
                } else if (todoOverlay.classList.contains('active')) {
                    toggleTodoForm();
                }
            }
        });
    }

    // 从浮窗添加日常任务
    function addDailyTaskFromForm() {
        const dailyTaskInput = document.getElementById('dailyTaskInputForm').value;
        const dailyTaskStartTime = document.getElementById('dailyTaskStartTimeForm').value;
        const dailyTaskEndTime = document.getElementById('dailyTaskEndTimeForm').value;

        if (dailyTaskInput) {
            const dailyTask = {
                task: dailyTaskInput,
                startTime: dailyTaskStartTime || '',
                endTime: dailyTaskEndTime || '',
                completed: false,
                id: new Date().getTime()
            };

            dailyTaskData.push(dailyTask);
            
            // 重新排序
            sortDailyTaskData();
            
            localStorage.setItem('dailyTaskData', JSON.stringify(dailyTaskData));
            renderDailyTasks();
            
            // 关闭浮窗并重置表单
            toggleDailyTaskForm();
            resetDailyTaskForm();
        } else {
            showConfirm('提示', '请输入日常任务！', function() {
                // 空回调，只是显示提示
            });
        }
    }
    
    // 从浮窗添加普通任务
    function addTodoFromForm() {
        const todoInput = document.getElementById('todoInputForm').value;
        const todoDate = document.getElementById('todoDateForm').value;
        const todoStartTime = document.getElementById('todoStartTimeForm').value;
        const todoEndTime = document.getElementById('todoEndTimeForm').value;

        if (todoInput && todoDate) {
            const newTodo = {
                task: todoInput,
                date: todoDate,
                startTime: todoStartTime || '',
                endTime: todoEndTime || '',
                id: new Date().getTime(),
                completed: false,
                archived: false
            };

            todoData.push(newTodo);
            
            // 重新排序
            sortTodoData();
            
            localStorage.setItem('todoData', JSON.stringify(todoData));
            renderTodos();
            
            // 关闭浮窗并重置表单
            toggleTodoForm();
            resetTodoForm();
        } else {
            showConfirm('提示', '请输入待办事项和日期！', function() {
                // 空回调，只是显示提示
            });
        }
    }
    
    // 重置日常任务表单
    function resetDailyTaskForm() {
        document.getElementById('dailyTaskInputForm').value = '';
        document.getElementById('dailyTaskStartTimeForm').value = '';
        document.getElementById('dailyTaskEndTimeForm').value = '';
    }
    
    // 重置普通任务表单
    function resetTodoForm() {
        document.getElementById('todoInputForm').value = '';
        document.getElementById('todoStartTimeForm').value = '';
        document.getElementById('todoEndTimeForm').value = '';
    }

    function renderDailyTasks() {
        const dailyTaskList = document.getElementById('dailyTaskList');
        dailyTaskList.innerHTML = '';
        
        // 重新排序
        sortDailyTaskData();
        
        dailyTaskData.forEach(dailyTask => {
            displayDailyTask(dailyTask);
        });
    }

    function displayDailyTask(dailyTask) {
        const dailyTaskList = document.getElementById('dailyTaskList');
        
        const dailyTaskDiv = document.createElement('div');
        dailyTaskDiv.className = 'daily-task';
        dailyTaskDiv.dataset.id = dailyTask.id;
        
        if (dailyTask.completed) {
            dailyTaskDiv.classList.add('completed');
        }

        let taskContent = '';
        if (dailyTask.startTime && dailyTask.endTime) {
            taskContent = `${dailyTask.task}<br><small class="task-time">${dailyTask.startTime} 到 ${dailyTask.endTime}</small>`;
        } else {
            taskContent = dailyTask.task;
        }

        dailyTaskDiv.innerHTML = taskContent;

        // 添加点击事件
        dailyTaskDiv.onclick = function(e) {
            if (e.target.tagName !== 'BUTTON') {
                toggleDailyTaskComplete(dailyTask.id, this);
            }
        };

        const deleteButton = document.createElement('button');
        deleteButton.innerText = '删除';
        deleteButton.onclick = function(event) {
            event.stopPropagation();
            deleteDailyTaskData = dailyTask;
            deleteDailyTaskDiv = dailyTaskDiv;
            showConfirm('删除确认', `确定要删除"${dailyTask.task}"这个日常任务吗？`, function() {
                performDailyTaskDeletion();
            });
        };
        
        dailyTaskDiv.appendChild(deleteButton);
        dailyTaskList.appendChild(dailyTaskDiv);
    }

    function toggleDailyTaskComplete(taskId, taskDiv) {
        const task = dailyTaskData.find(t => t.id === taskId);
        if (task) {
            task.completed = !task.completed;
            taskDiv.classList.toggle('completed');
            
            // 重新排序
            sortDailyTaskData();
            localStorage.setItem('dailyTaskData', JSON.stringify(dailyTaskData));
            
            // 重新渲染以更新排序
            renderDailyTasks();
        }
    }

    function performDailyTaskDeletion() {
        if (deleteDailyTaskData && deleteDailyTaskDiv) {
            dailyTaskData = dailyTaskData.filter(task => task.id !== deleteDailyTaskData.id);
            
            // 重新排序
            sortDailyTaskData();
            
            localStorage.setItem('dailyTaskData', JSON.stringify(dailyTaskData));
            
            // 重新渲染
            renderDailyTasks();
            
            deleteDailyTaskData = null;
            deleteDailyTaskDiv = null;
        }
    }

    function renderTodos() {
        // 先排序
        sortTodoData();
        
        const todoList = document.getElementById('todoList');
        todoList.innerHTML = '';

        let groupedTodos = {};

        todoData.forEach(todo => {
            if (!groupedTodos[todo.date]) {
                groupedTodos[todo.date] = [];
            }
            groupedTodos[todo.date].push(todo);
        });

        // 按日期排序
        const sortedDates = Object.keys(groupedTodos).sort();

        for (const date of sortedDates) {
            const dateGroup = document.createElement('div');
            dateGroup.className = 'date-group';
            const dateLabel = document.createElement('h3');
            
            // 使用新的日期格式化函数
            dateLabel.innerText = formatDateForDisplay(date);
            dateGroup.appendChild(dateLabel);
            
            groupedTodos[date].forEach(todo => {
                const todoItem = document.createElement('div');
                todoItem.className = 'todo-item';
                todoItem.dataset.id = todo.id;
                
                if (todo.completed) {
                    todoItem.classList.add('completed');
                }

                let timeLabel = '';
                
                if (todo.startTime && todo.endTime) {
                    timeLabel = `<small class="task-time">${todo.startTime} 到 ${todo.endTime}</small>`;
                }
                
                todoItem.innerHTML = `
                    <div>
                        <span>${todo.task}</span>
                        ${timeLabel}
                    </div>
                    <button onclick="showTodoDeleteConfirm(${todo.id}, '${todo.task.replace(/'/g, "\\'")}')">删除</button>
                `;
                
                // 添加点击事件
                todoItem.onclick = function(e) {
                    if (e.target.tagName !== 'BUTTON') {
                        toggleTodoComplete(todo.id, this);
                    }
                };
                
                dateGroup.appendChild(todoItem);
            });
            todoList.appendChild(dateGroup);
        }
    }

    function toggleTodoComplete(todoId, todoItem) {
        const todo = todoData.find(t => t.id === todoId);
        if (todo) {
            todo.completed = !todo.completed;
            todoItem.classList.toggle('completed');
            
            // 当日完成的任务不立即归档，等到第二天0点再归档
            // 只标记为已完成，不调用 archiveTodo 函数
            
            // 重新排序
            sortTodoData();
            localStorage.setItem('todoData', JSON.stringify(todoData));
            
            // 重新渲染以更新排序
            renderTodos();
        }
    }

    // 修改归档任务函数，添加isOldTask参数
    function archiveTodo(todo, isOldTask = false) {
        const now = new Date();
        const today = now.toISOString().split('T')[0];
        
        // 如果是今天的任务，不归档（除非是0点触发的旧任务归档）
        if (todo.date === today && !isOldTask) {
            console.log('今日任务不立即归档，等待0点处理');
            return;
        }
        
        // 标记任务为已归档
        todo.archived = true;
        
        const archivedTask = {
            ...todo,
            archivedDate: now.toISOString().split('T')[0], // 归档日期
            archivedTime: now.toLocaleTimeString('zh-CN', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false
            })
        };
        
        // 如果是0点触发的旧任务归档，不移除主列表中的任务
        // 只在新归档任务中添加，但主列表中仍然保留（标记为已归档）
        if (!isOldTask) {
            // 从todoData中移除已归档的任务（当日手动归档的情况）
            todoData = todoData.filter(t => t.id !== todo.id);
        }
        
        archivedTodos.unshift(archivedTask); // 添加到开头（最新的在前）
        localStorage.setItem('todoData', JSON.stringify(todoData));
        localStorage.setItem('archivedTodos', JSON.stringify(archivedTodos));
        
        if (!isOldTask) {
            // 立即重新渲染主界面的任务列表（仅当日手动归档时）
            renderTodos();
        }
        
        console.log(`任务"${todo.task}"已归档`);
    }

    // 归档功能
    function showArchive() {
        closeMenu();
        renderArchive();
        document.getElementById('archiveOverlay').classList.add('active');
        document.body.style.overflow = 'hidden';
    }
    
    function hideArchive() {
        document.getElementById('archiveOverlay').classList.remove('active');
        document.body.style.overflow = '';
    }
    
    function renderArchive() {
        const archiveContent = document.getElementById('archiveContent');
        archiveContent.innerHTML = '';
        
        if (archivedTodos.length === 0) {
            archiveContent.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">暂无归档的任务</div>';
            return;
        }
        
        // 按归档日期分组
        let groupedByDate = {};
        
        archivedTodos.forEach(task => {
            const archiveDate = task.archivedDate || task.date;
            if (!groupedByDate[archiveDate]) {
                groupedByDate[archiveDate] = [];
            }
            groupedByDate[archiveDate].push(task);
        });
        
        // 按日期倒序排列（最新的在前）
        const sortedDates = Object.keys(groupedByDate).sort((a, b) => b.localeCompare(a));
        
        for (const date of sortedDates) {
            const dateGroup = document.createElement('div');
            dateGroup.className = 'archive-date-group';
            
            const dateLabel = document.createElement('h3');
            dateLabel.className = 'archive-date-title';
            
            // 使用新的日期格式化函数
            dateLabel.innerText = formatDateForDisplay(date);
            dateGroup.appendChild(dateLabel);
            
            // 按时间排序 - 与主界面逻辑一致
            groupedByDate[date].sort((a, b) => {
                const aHasTime = a.startTime && a.endTime;
                const bHasTime = b.startTime && b.endTime;
                
                if (aHasTime && !bHasTime) return -1;
                if (!aHasTime && bHasTime) return 1;
                if (aHasTime && bHasTime) {
                    return a.startTime.localeCompare(b.startTime);
                }
                return 0;
            });
            
            groupedByDate[date].forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.className = 'archive-task';
                
                if (!task.startTime && !task.endTime) {
                    taskElement.classList.add('no-time');
                }
                
                if (task.completed) {
                    taskElement.classList.add('completed');
                }
                
                // 与主界面完全一致的显示方式
                let timeLabel = '';
                if (task.startTime && task.endTime) {
                    timeLabel = `<small class="archive-task-time">${task.startTime} 到 ${task.endTime}</small>`;
                }
                
                taskElement.innerHTML = `
                    <div class="archive-task-content">${task.task}</div>
                    ${timeLabel}
                `;
                
                dateGroup.appendChild(taskElement);
            });
            
            archiveContent.appendChild(dateGroup);
        }
    }
    
    // 清空归档 - 修改提示信息
    function clearArchive() {
        showConfirm('清空归档', '确定要清空所有归档的任务吗？', function() {
            archivedTodos = [];
            localStorage.setItem('archivedTodos', JSON.stringify(archivedTodos));
            renderArchive();
        });
    }

    function showTodoDeleteConfirm(id, taskName) {
        deleteTodoId = id;
        showConfirm('删除确认', `确定要删除"${taskName}"这个任务吗？`, function() {
            performTodoDeletion();
        });
    }

    function performTodoDeletion() {
        if (deleteTodoId) {
            todoData = todoData.filter(todo => todo.id !== deleteTodoId);
            
            // 重新排序
            sortTodoData();
            
            localStorage.setItem('todoData', JSON.stringify(todoData));
            renderTodos();
            deleteTodoId = null;
        }
    }

    function changeBackground() {
        closeMenu();
        document.getElementById('fileInput').click();
    }

    function setBackgroundImage(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const background = document.getElementById('background');
                background.style.backgroundImage = `url(${e.target.result})`;
                adjustButtonColor(e.target.result);
                saveBackground(e.target.result);
            };
            reader.readAsDataURL(file);
        }
    }
    
    // 点击归档面板外部关闭
    document.getElementById('archiveOverlay').addEventListener('click', function(e) {
        if (e.target === this) {
            hideArchive();
        }
    });
    
    // 按ESC键关闭归档面板
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const archiveOverlay = document.getElementById('archiveOverlay');
            if (archiveOverlay.classList.contains('active')) {
                hideArchive();
            }
        }
    });
    
    // 点击对话框外部关闭
    document.getElementById('confirmDialog').addEventListener('click', function(e) {
        if (e.target === this) {
            hideConfirm();
        }
    });
    
    // 按ESC键关闭对话框
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            hideConfirm();
        }
    });
</script>
</body>
</html>

